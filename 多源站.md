一、项目背景与目标
1. 背景概述
    ○ 公司业务全球化，需覆盖多区域用户，提升服务可用性与响应速度
    ○ 单一IDC部署的局限性（如网络延迟、区域故障风险）
2. 核心目标
    ○ 实现业务系统在全球多个IDC节点的分布式部署
    ○ 降低跨区域访问延迟，提升用户体验
    ○ 提高系统容灾能力，确保业务连续性

二、实施关键举措
1. 部署架构
● 美西源站选址策略
    ○ 根据用户地理分布、网络骨干节点、成本要求选择美西：Aws接入+腾讯云硅谷
    ○ 区域覆盖：北美、欧洲
● 网络架构
    ○ 负载均衡与流量调度：采用AWS GA全球网络加速，基于用户IP就近分配流量
    ○ 源站间网络链路冗余：双专线
    ○ App、小程序、门店设备：每个国家一个域名，未来可以按国家进行流量切换
    ○ 管理系统：每个源站一个域名
    ○ App老版本、设备激活：双源站共用统一域名，按地域进行域名解析
● 数据同步与一致性
    ○ 双站业务数据隔离
    ○ 定时任务数据同步：主档、UPMS
    ○ DTS数据同步：用户、地区、商品属性、手机区号、货币、短码、版本管理https://alidocs.dingtalk.com/i/nodes/o14dA3GK8g5Nm0xdi5bk99jyV9ekBD76
    ○ 数据一致性
        ■ DB数据一致性：DTS同步数据—DB数据一致性检测服务—定时20分钟一致性增量检测 
        ■ Redis缓存一致性：缓存一致性检测服务（用户双站Redis缓存）-延迟5s后检测不一致或不存在后调用业务接口更新缓存
● 服务架构
    ○ 服务和数据双站间独立
    ○ 大数据、对象存储双站共用
    ○ 用户服务：注册、登录、退登双站间无感切换。DB数据DTS双向同步，一方数据更新后双边更新Redis缓存
    ○ LOT服务双站共用阿里云服务
2. 合规性与安全性
● 数据本地化合规
    ○ 略
● 安全防护
    ○ WAF、DDoS防护部署源站入口
    ○ 美西访问亚太、国内网络组按需开放
3. 运维与监控
● 发布窗口
    ○ 美西：13:00-18:00
    ○ 亚太：23:00-08:00
● 流水线
    ○ 服务发布：流水线同时发布服务到两个源站，同时进入白名单和灰度阶段
    ○ 配置更新：流水线配置更新同时生成两个配置变更链接供开发修改服务配置
    ○ DBAuto：DB工单需分源站提两份
● 监控系统
    ○ 点选亚太和美西切换

三、性能对比
1. 前端性能对比：
    ○ DNS： 上涨20-80ms，双层GA DNS解析+LB导致（下周1去掉阿里GA后继续观察）
    ○ 请求：上涨150-200ms，双层GA DNS解析导致（下周1去掉阿里GA后继续观察）






前端CLS仪表盘https://console.cloud.tencent.com/cls/dashboard/d?id=dashboard-5561bad3-17e1-4f6b-95d8-ec3009324ae8&searchParams=RGFzaGJvYXJkTmFtZT0lRTYlQjUlQjclRTUlQTQlOTYmdmlld01vZGU9TGlzdE1vZGU&time=now-3d,now&timezone=browser&var-countryName=United%20States&var-versionCode=&var-userId=
2. 点单机-只有美国：DNS直接指向美西 AWS GA，目前看平均耗时下降280-300ms


    ○ https://sentry.heytea-co.com/
3. 后端性能对比
    ○ 美西和亚太基本一致




四、问题待办
1. 管理系统多源站
    a. 磐石系统：切换期间上线，暂未多源站改造
2. 网络接入优化 https://alidocs.dingtalk.com/i/nodes/N7dx2rn0JbZ9p50BsLEj7o0RJMGjLRb3?utm_scene=team_space&iframeQuery=sheet_range%3Dst-7183c14c-17778_9_3_1_1
    ○ 门店剩余3个域名接入GA：以便网络加速和快速切换
    ○ 流量转发优化：去掉阿里GA中间节点
        ■ 美西：C端、门店DNS-〉阿里云GA+DNS-〉AWS GA  优化 为 DNS-〉AWS GA
    ○ 小程序安全网关：50%用户
        ■ 去掉后可少一次网络转发
3. 服务耦合
    ○ 海外依赖国内：需解耦不依赖跨站跨洋Api，通过数据层同步实现
        ■ BOH、主档、UPMS：通过API调用国内
        ■ 门店信息和状态同步国内：美西-〉kafka-〉亚太，亚太Api调回国内
        ■ 亚太服务连接国内zk服务生成uuid
    ○ 源站内部服务耦合：需解耦
        ■ 门店设备：海外选购创建门店-〉国内主档-〉同步到海外门店（问题来源：美国新建测试门店后，云雀读取不到新建的门店ID）
        ■ 业务数据未从db_production拆出去：upms、候餐屏、选购、用户券
    ○ 设备
        ■ 出茶机复用小程序go.heytea-co.com域名，应推动第三方升级隔离
4. 缓存未自动加载
    ○ 菜单：App、小程序菜单页空白
    ○ 券库存：门店券无法展示
    ○ 揭秘页：揭秘页不展示
5. 数据一致性
    ○ updated_at字段缺失或没索引，数据一致性检测服务无法配置检测

    ○ 用户数据源站间DTS同步延迟1.7s，更新对方缓存时DB数据不存在，触发缓存一致性检测缓存不一致更新每分钟4-5次，业务服务需调整缓存更新逻辑减少不一致
6. 监控系统
    ○ 海外监控系统落后国内1年，告警规则未收归
7. 性能优化
    ○ C端、门店端接口性能跟踪和优化
8. 容灾：待完成

五、经验总结
1. 门店设备验证：设备多样，需要有统一的远程工具，协助定位网络问题、日志排查
2. 门店设备配置HOST不方便：采取办公和dev wifi网络劫持是比较快捷有效的方式